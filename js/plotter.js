L.Polyline.plotter=L.Polyline.extend({_lineMarkers:[],_editIcon:L.divIcon({className:"leaflet-div-icon leaflet-editing-icon"}),_halfwayPointMarkers:[],_existingLatLngs:[],options:{weight:2,color:"#000"},initialize:function(e,t){this._setExistingLatLngs(e);L.Polyline.prototype.initialize.call(this,[],t)},onAdd:function(e){L.Polyline.prototype.onAdd.call(this,e);this._map=e;this._plotExisting();this._bindMapClick()},setLatLngs:function(e){L.Polyline.prototype.setLatLngs.call(this,e)},_bindMapClick:function(){this._map.on("click",this._addNewMarker,this)},_setExistingLatLngs:function(e){this._existingLatLngs=e},_replot:function(){this._redraw();this._redrawHalfwayPoints()},_getNewMarker:function(e,t){t.draggable=!0;return new L.marker(e,t)},_addToMapAndBindMarker:function(e){e.addTo(this._map);e.on("click",this._removePoint,this);e.on("drag",this._replot,this)},_removePoint:function(e){this._map.removeLayer(this._lineMarkers[this._lineMarkers.indexOf(e.target)]);this._lineMarkers.splice(this._lineMarkers.indexOf(e.target),1);this._replot()},_addNewMarker:function(e){var t=this._getNewMarker(e.latlng,{icon:this._editIcon});this._addToMapAndBindMarker(t);this._lineMarkers.push(t);this._replot()},_redrawHalfwayPoints:function(){for(index in this._halfwayPointMarkers){index=parseInt(index);this._map.removeLayer(this._halfwayPointMarkers[index])}for(index in this._lineMarkers){index=parseInt(index);if(typeof this._lineMarkers[index+1]=="undefined")return;var e=(new L.Marker([(this._lineMarkers[index].getLatLng().lat+this._lineMarkers[index+1].getLatLng().lat)/2,(this._lineMarkers[index].getLatLng().lng+this._lineMarkers[index+1].getLatLng().lng)/2],{icon:this._editIcon,opacity:.5})).addTo(this._map);e.index=index;e.on("click",this._addHalfwayPoint,this);this._halfwayPointMarkers.push(e)}},_addHalfwayPoint:function(e){var t=this._getNewMarker(e.latlng,{icon:this._editIcon});this._addToMapAndBindMarker(t);this._lineMarkers.splice(e.target.index+1,0,t);this._replot()},_plotExisting:function(){for(index in this._existingLatLngs)this._addNewMarker({latlng:new L.LatLng(this._existingLatLngs[index][0],this._existingLatLngs[index][1])})},_redraw:function(){this.setLatLngs([]);this.redraw();for(index in this._lineMarkers)this.addLatLng(this._lineMarkers[index].getLatLng());this.redraw()}});L.Polyline.Plotter=function(e,t){return new L.Polyline.plotter(e,t)};